name: Build macOS App

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-apple-silicon:
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build app
        run: cargo build --release -p app

      - name: Create Little Helper.app bundle
        run: |
          mkdir -p "Little Helper.app/Contents/MacOS"
          mkdir -p "Little Helper.app/Contents/Resources"
          cp target/release/app "Little Helper.app/Contents/MacOS/Little Helper"
          chmod +x "Little Helper.app/Contents/MacOS/Little Helper"

          cat > "Little Helper.app/Contents/Info.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>Little Helper</string>
              <key>CFBundleIdentifier</key>
              <string>com.littlehelper.app</string>
              <key>CFBundleName</key>
              <string>Little Helper</string>
              <key>CFBundleVersion</key>
              <string>1.0.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0.0</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>LSMinimumSystemVersion</key>
              <string>11.0</string>
          </dict>
          </plist>
          EOF

      - name: Create Setup app (one-click installer)
        run: |
          # Compile AppleScript to .app
          osacompile -o "Setup Little Helper.app" installer/setup.applescript

          # Copy install script into the Setup app bundle
          cp installer/install.sh "Setup Little Helper.app/Contents/Resources/"
          chmod +x "Setup Little Helper.app/Contents/Resources/install.sh"

          # Verify
          echo "Setup app contents:"
          ls -la "Setup Little Helper.app/Contents/Resources/"

      - name: Create release zip
        run: |
          # Create a folder with both apps
          mkdir -p "LittleHelper-Installer"
          cp -r "Setup Little Helper.app" "LittleHelper-Installer/"
          cp -r "Little Helper.app" "LittleHelper-Installer/"

          # Add a simple README
          cat > "LittleHelper-Installer/READ ME FIRST.txt" << 'EOF'
          Welcome to Little Helper!

          EASY INSTALL (Recommended):
          1. Double-click "Setup Little Helper.app"
          2. Click "Install"
          3. Follow the prompts
          4. Done! Little Helper will open automatically.

          Note: Your Mac password is needed once to install the AI engine.

          MANUAL INSTALL:
          1. Drag "Little Helper.app" to Applications
          2. Install Ollama from https://ollama.com/download
          3. Open Terminal and run: ollama pull llama3.2:3b
          4. Open Little Helper from Applications

          First time opening: macOS may warn about "unidentified developer"
          Just right-click the app > Open > Open

          Enjoy your new AI assistant!
          EOF

          # Zip it
          zip -r "LittleHelper-macOS-arm64.zip" "LittleHelper-Installer"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: LittleHelper-arm64
          path: "LittleHelper-macOS-arm64.zip"

  release:
    needs: build-apple-silicon
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: LittleHelper-arm64

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: LittleHelper-macOS-arm64.zip
          body: |
            ## Little Helper ${{ github.ref_name }}

            ### One-Click Install
            1. Download the zip below
            2. Unzip it
            3. Double-click **"Setup Little Helper.app"**
            4. Click **Install**
            5. Enter your Mac password when asked
            6. Wait ~5 minutes for AI model to download
            7. Done! App opens automatically.

            **Note:** First time opening, macOS may warn about "unidentified developer".
            Right-click > Open > Open to bypass.

            **Requirements:** Apple Silicon Mac (M1/M2/M3/M4) with macOS 11+
          draft: false
          prerelease: false
