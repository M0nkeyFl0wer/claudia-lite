name: Build Apps

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-mac:
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build app
        run: cargo build --release -p app

      - name: Create Little Helper.app bundle
        run: |
          mkdir -p "Little Helper.app/Contents/MacOS"
          mkdir -p "Little Helper.app/Contents/Resources"
          cp target/release/app "Little Helper.app/Contents/MacOS/Little Helper"
          chmod +x "Little Helper.app/Contents/MacOS/Little Helper"

          cat > "Little Helper.app/Contents/Info.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>Little Helper</string>
              <key>CFBundleIdentifier</key>
              <string>com.littlehelper.app</string>
              <key>CFBundleName</key>
              <string>Little Helper</string>
              <key>CFBundleVersion</key>
              <string>1.0.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0.0</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>LSMinimumSystemVersion</key>
              <string>11.0</string>
          </dict>
          </plist>
          EOF

      - name: Create Setup app (one-click installer)
        run: |
          osacompile -o "Setup Little Helper.app" installer/setup.applescript
          cp installer/install.sh "Setup Little Helper.app/Contents/Resources/"
          chmod +x "Setup Little Helper.app/Contents/Resources/install.sh"

      - name: Create release zip
        run: |
          mkdir -p "LittleHelper-Installer"
          cp -r "Setup Little Helper.app" "LittleHelper-Installer/"
          cp -r "Little Helper.app" "LittleHelper-Installer/"

          cat > "LittleHelper-Installer/READ ME FIRST.txt" << 'EOF'
          Welcome to Little Helper!

          EASY INSTALL:
          1. Double-click "Setup Little Helper.app"
          2. Click "Install"
          3. Follow the prompts
          4. Done!

          Your Mac password is needed once for the AI engine.

          First time opening: if macOS warns about "unidentified developer"
          just right-click the app > Open > Open

          Enjoy!
          EOF

          zip -r "LittleHelper-macOS-arm64.zip" "LittleHelper-Installer"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: LittleHelper-macOS
          path: "LittleHelper-macOS-arm64.zip"

  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build app
        run: cargo build --release -p app

      - name: Create release zip
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "LittleHelper-Installer"

          # Copy the exe
          Copy-Item "target/release/app.exe" "LittleHelper-Installer/LittleHelper.exe"

          # Copy installer script
          Copy-Item "installer/install-windows.ps1" "LittleHelper-Installer/Install.ps1"

          # Create a batch file to run PowerShell script easily
          @"
          @echo off
          echo Starting Little Helper Setup...
          powershell -ExecutionPolicy Bypass -File "%~dp0Install.ps1"
          "@ | Out-File -FilePath "LittleHelper-Installer/Install.bat" -Encoding ASCII

          # Create README
          @"
          Welcome to Little Helper!

          EASY INSTALL:
          1. Double-click "Install.bat"
          2. Follow the prompts
          3. Done!

          MANUAL INSTALL:
          1. Copy LittleHelper.exe wherever you want
          2. Install Ollama from https://ollama.com/download
          3. Open Command Prompt and run: ollama pull llama3.2:3b
          4. Run LittleHelper.exe

          Enjoy!
          "@ | Out-File -FilePath "LittleHelper-Installer/READ ME FIRST.txt" -Encoding UTF8

          # Zip it
          Compress-Archive -Path "LittleHelper-Installer" -DestinationPath "LittleHelper-Windows.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: LittleHelper-Windows
          path: "LittleHelper-Windows.zip"

  release:
    needs: [build-mac, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Download Mac build
        uses: actions/download-artifact@v4
        with:
          name: LittleHelper-macOS

      - name: Download Windows build
        uses: actions/download-artifact@v4
        with:
          name: LittleHelper-Windows

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            LittleHelper-macOS-arm64.zip
            LittleHelper-Windows.zip
          body: |
            ## Little Helper ${{ github.ref_name }}

            ### Mac (Apple Silicon)
            1. Download `LittleHelper-macOS-arm64.zip`
            2. Unzip it
            3. Double-click **"Setup Little Helper.app"**
            4. Click Install, enter password, wait ~5 min
            5. Done!

            *First time: if macOS warns "unidentified developer" → right-click > Open > Open*

            ### Windows
            1. Download `LittleHelper-Windows.zip`
            2. Unzip it
            3. Double-click **"Install.bat"**
            4. Follow prompts, wait ~5 min for AI download
            5. Done!

            *Windows may show SmartScreen warning → click "More info" > "Run anyway"*

            ---
            **Requirements:**
            - Mac: Apple Silicon (M1/M2/M3/M4), macOS 11+
            - Windows: Windows 10/11, 64-bit
          draft: false
          prerelease: false
